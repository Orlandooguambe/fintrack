{% extends 'base.html' %}
{% block content %}

<div class="pagetitle mb-3">
  <h1 class="d-flex align-items-center gap-2 m-0">
    <i class="bi bi-speedometer2 text-primary"></i>
    <span>Dashboard</span>
  </h1>
  <div class="text-muted small">Visão rápida do teu mês em FinTrack</div>
</div>

<section class="section dashboard">
  <div class="row g-3">

    <!-- Entradas do mês -->
    <div class="col-12 col-sm-6 col-lg-3">
      <div class="card fintrack-kpi kpi-income">
        <div class="card-body">
          <div class="kpi-head">
            <div class="kpi-icon-circle kpi-icon-income">
              <i class="bi bi-cash-coin"></i>
            </div>
            <span>Entradas (mês)</span>
          </div>
          <div class="kpi-value">{{ '%.2f' % total_in }} MT</div>
          <div class="kpi-footnote">*Sem transfer internas</div>
        </div>
      </div>
    </div>

    <!-- Saídas do mês -->
    <div class="col-12 col-sm-6 col-lg-3">
      <div class="card fintrack-kpi kpi-expense">
        <div class="card-body">
          <div class="kpi-head">
            <div class="kpi-icon-circle kpi-icon-expense">
              <i class="bi bi-wallet2"></i>
            </div>
            <span>Saídas (mês)</span>
          </div>
          <div class="kpi-value">{{ '%.2f' % total_out }} MT</div>
          <div class="kpi-footnote">Média diária: {{ '%.2f' % avg_daily_spend }} MT</div>
        </div>
      </div>
    </div>

    <!-- Resultado e poupança -->
    <div class="col-12 col-sm-6 col-lg-3">
      <div class="card fintrack-kpi kpi-result">
        <div class="card-body">
          <div class="kpi-head">
            <div class="kpi-icon-circle kpi-icon-result">
              <i class="bi bi-piggy-bank"></i>
            </div>
            <span>Resultado do mês</span>
          </div>
          <div class="kpi-value">{{ '%.2f' % net_month }} MT</div>
          <div class="kpi-footnote">Taxa de poupança: {{ '%.1f' % savings_rate }}%</div>
        </div>
      </div>
    </div>

    <!-- Dívidas em aberto -->
    <div class="col-12 col-sm-6 col-lg-3">
      <div class="card fintrack-kpi kpi-debt">
        <div class="card-body">
          <div class="kpi-head">
            <div class="kpi-icon-circle kpi-icon-debt">
              <i class="bi bi-credit-card-2-back"></i>
            </div>
            <span>Dívidas em aberto</span>
          </div>
          <div class="kpi-value">{{ '%.2f' % divida_aberta }} MT</div>
          <div class="kpi-footnote">Top despesa: {{ top_exp_cat }}</div>
        </div>
      </div>
    </div>

    <!-- Comparativo mensal: Entradas vs Saídas (últimos 12 meses) -->
<div class="col-12">
  <div class="card fintrack-card-chart">
    <div class="card-body">
      <h5 class="card-title">
        <i class="bi bi-calendar3"></i>
        <span>Entradas vs Saídas por mês (últimos 12)</span>
      </h5>

      <div class="d-flex flex-wrap gap-2 mb-2 small">
        <span class="badge bg-success-subtle text-success">
          <i class="bi bi-trophy"></i> Maior Entrada: 
          <strong>{{ top_income_month }}</strong> — {{ '%.2f' % top_income_value }} MT
        </span>
        <span class="badge bg-danger-subtle text-danger">
          <i class="bi bi-graph-down"></i> Maior Saída:
          <strong>{{ top_expense_month }}</strong> — {{ '%.2f' % top_expense_value }} MT
        </span>
        <span class="badge bg-primary-subtle text-primary">
          <i class="bi bi-piggy-bank"></i> Melhor Poupança (net):
          <strong>{{ top_saving_month }}</strong> — {{ '%.2f' % top_saving_value }} MT
        </span>
      </div>

      <div class="chart-wrapper">
        <canvas id="mesesChart"></canvas>
      </div>
      <div class="fintrack-hint mt-2">
        * Valores excluem transferências internas. “Poupança (net)” = Entradas − Saídas do mês.
      </div>
    </div>
  </div>
</div>


    <!-- Fluxo últimos 30 dias -->
    <div class="col-12 col-xl-8">
      <div class="card fintrack-card-chart">
        <div class="card-body">
          <h5 class="card-title">
            <i class="bi bi-graph-up"></i>
            <span>Fluxo últimos 30 dias</span>
          </h5>
          <div class="chart-wrapper">
            <canvas id="fluxoChart"></canvas>
          </div>
          <div class="fintrack-hint mt-2">
            * Entradas / Saídas excluem transferências internas.
          </div>
        </div>
      </div>
    </div>

    <!-- Despesas por categoria -->
    <div class="col-12 col-xl-4">
      <div class="card fintrack-card-chart">
        <div class="card-body">
          <h5 class="card-title">
            <i class="bi bi-pie-chart"></i>
            <span>Despesas por categoria (mês)</span>
          </h5>
          <div class="chart-wrapper">
            <canvas id="catPie"></canvas>
          </div>
        </div>
      </div>
    </div>

  </div>
</section>

{% endblock %}

{% block scripts %}
<script>
  // Paleta FinTrack
  const FT_BLUE  = '#007bff';
  const FT_BLUE_SOFT = 'rgba(0,123,255,0.15)';
  const FT_GREEN = '#00c47a';
  const FT_GREEN_SOFT = 'rgba(0,196,122,0.15)';
  const FT_GREY_LINE = 'rgba(0,0,0,0.06)';

  // Opções base para gráficos
  const baseOpts = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'top',
        labels: { boxWidth: 10, boxHeight: 10 }
      },
      tooltip: { mode: 'index', intersect: false }
    },
    layout: { padding: 0 },
    interaction: { mode: 'nearest', intersect: false },
    scales: {
      x: { ticks: { maxRotation: 0 }, grid: { display: false } },
      y: { beginAtZero: true, grid: { color: FT_GREY_LINE } }
    }
  };

  // Fluxo últimos 30 dias (linha)
  new Chart(document.getElementById('fluxoChart'), {
    type: 'line',
    data: {
      labels: {{ labels|tojson }},
      datasets: [
        {
          label: 'Entradas',
          data: {{ incs|tojson }},
          borderColor: FT_GREEN,
          backgroundColor: FT_GREEN_SOFT,
          borderWidth: 2,
          tension: 0.3,
          fill: true,
          pointRadius: 0
        },
        {
          label: 'Saídas',
          data: {{ exps|tojson }},
          borderColor: FT_BLUE,
          backgroundColor: FT_BLUE_SOFT,
          borderWidth: 2,
          tension: 0.3,
          fill: true,
          pointRadius: 0
        }
      ]
    },
    options: baseOpts
  });

  // Comparativo mensal (barras para entradas/saídas + linha para net)
const mmLabels = {{ months_labels|tojson }};
const mmIn = {{ months_in|tojson }};
const mmOut = {{ months_out|tojson }};
const mmNet = {{ months_net|tojson }};

new Chart(document.getElementById('mesesChart'), {
  type: 'bar',
  data: {
    labels: mmLabels,
    datasets: [
      {
        type: 'bar',
        label: 'Entradas',
        data: mmIn,
        backgroundColor: FT_GREEN,
        borderColor: FT_GREEN,
        borderWidth: 1,
        borderRadius: 6,
        barThickness: 24,
        maxBarThickness: 28
      },
      {
        type: 'bar',
        label: 'Saídas',
        data: mmOut,
        backgroundColor: FT_BLUE,
        borderColor: FT_BLUE,
        borderWidth: 1,
        borderRadius: 6,
        barThickness: 24,
        maxBarThickness: 28
      },
      {
        type: 'line',
        label: 'Poupança (net)',
        data: mmNet,
        borderColor: '#495057',
        backgroundColor: 'rgba(73,80,87,0.15)',
        borderWidth: 2,
        tension: 0.3,
        pointRadius: 3,
        yAxisID: 'y'
      }
    ]
  },
  options: {
    ...baseOpts,
    plugins: {
      ...baseOpts.plugins,
      tooltip: {
        mode: 'index',
        intersect: false,
        callbacks: {
          label: (ctx) => {
            const v = ctx.parsed.y ?? ctx.parsed;
            return `${ctx.dataset.label}: ${Number(v).toLocaleString('pt-PT', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} MT`;
          }
        }
      }
    },
    scales: {
      x: { grid: { display: false } },
      y: { beginAtZero: true, grid: { color: FT_GREY_LINE } }
    }
  }
});

  // Despesas por categoria (doughnut)
  // vamos alternar cores azul/verde/azul/verde...
  // dados vindos do backend
  const pieCats = {{ exp_cats|tojson }};
  const pieVals = {{ exp_vals|tojson }};

  // hash -> Hue (0–359). Mantém cor estável por categoria.
  function hueFromString(str) {
    let h = 0;
    for (let i = 0; i < str.length; i++) {
      h = (h * 31 + str.charCodeAt(i)) >>> 0;
    }
    return h % 360;
  }

  // gera paleta HSL bonita e consistente por categoria
  const pieBg = pieCats.map(cat => `hsl(${hueFromString(cat)}, 70%, 55%)`);
  const pieBorder = pieCats.map(cat => `hsl(${hueFromString(cat)}, 70%, 40%)`);

  const totalPie = pieVals.reduce((a, b) => a + b, 0) || 1;

  const pieOpts = {
    responsive: true,
    maintainAspectRatio: false,
    cutout: '55%',
    plugins: {
      legend: {
        position: 'bottom',
        labels: { boxWidth: 12, boxHeight: 12 }
      },
      tooltip: {
        callbacks: {
          label: (ctx) => {
            const v = ctx.parsed;
            const pct = ((v * 100) / totalPie).toFixed(1);
            // ex.: "Alimentação: 1 250,00 MT (23,5%)"
            return `${ctx.label}: ${v.toLocaleString('pt-PT', {minimumFractionDigits:2, maximumFractionDigits:2})} MT (${pct}%)`;
          }
        }
      }
    }
  };

  new Chart(document.getElementById('catPie'), {
    type: 'doughnut',
    data: {
      labels: pieCats,
      datasets: [{
        data: pieVals,
        backgroundColor: pieBg,
        borderColor: pieBorder,
        borderWidth: 2,
        hoverOffset: 6
      }]
    },
    options: pieOpts
  });
</script>
{% endblock %}
