{% extends 'base.html' %}
{% block content %}

<style>
  /* ===== PDF-safe refinements (wkhtmltopdf) ===== */
  .report-kpi .card-body,
  .report-section .card-body { padding: 14px 16px; }

  .text-mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace; }

  /* Fallback de cor sólida (se o engine ignorar gradient) */
  .kpi--poupanca { background-color: rgba(14,165,166,.08); }
  .kpi--despesas { background-color: rgba(245,158,11,.08); }
  .kpi--entradas { background-color: rgba(22,163,74,.08); }
  .kpi--saidas   { background-color: rgba(220,38,38,.08); }
  .kpi--totais   { background-color: rgba(99,102,241,.08); }

  .badge-transfer {
    background: #6c757d; color: #fff; border-radius: 8px;
    padding: .2rem .5rem; font-size: .75rem;
  }

  /* Listas com divisórias visíveis no PDF */
  .list-group .list-group-item{
    border-color:#e2e8f0;
    display:flex; align-items:center; justify-content:space-between;
  }

  /* Tabelas compactas e legíveis */
  .table-sm th, .table-sm td { padding: .35rem .5rem; }
  .table thead th { background:#f8fafc; border-bottom:1px solid #e2e8f0; }
  .table tbody tr:hover { background:#f9fafb; }

  /* Esconde botões no print/pdf */
  @media print { a.btn { display: none !important; } }
</style>

<div class="pagetitle d-flex justify-content-between align-items-center">
  <h1>Relatório financeiro</h1>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-primary" href="{{ url_for('report_pdf') }}">
      <i class="bi bi-filetype-pdf"></i> Exportar PDF
    </a>
  </div>
</div>

<section class="section report-kpi">
  <!-- Linha 1: saldos e património -->
  <div class="row g-3">
    <div class="col-12 col-sm-6 col-lg-3">
      <div class="card kpi-card kpi--poupanca">
        <div class="card-body">
          <h5 class="card-title d-flex align-items-center gap-2 m-0">
            <span class="kpi-icon"><i class="bi bi-piggy-bank"></i></span>
            Poupança
          </h5>
          <div class="mt-2">
            <div class="h3 m-0 text-mono">{{ '%.2f' % saldo_poupanca }} MT</div>
            <div class="kpi-sub">Saldo atual</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-sm-6 col-lg-3">
      <div class="card kpi-card kpi--despesas">
        <div class="card-body">
          <h5 class="card-title d-flex align-items-center gap-2 m-0">
            <span class="kpi-icon"><i class="bi bi-wallet2"></i></span>
            Despesas
          </h5>
          <div class="mt-2">
            <div class="h3 m-0 text-mono">{{ '%.2f' % saldo_despesas }} MT</div>
            <div class="kpi-sub">Saldo atual</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-sm-6 col-lg-3">
      <div class="card kpi-card kpi--totais">
        <div class="card-body">
          <h5 class="card-title d-flex align-items-center gap-2 m-0">
            <span class="kpi-icon"><i class="bi bi-bank"></i></span>
            Saldos totais
          </h5>
          <div class="mt-2">
            <div class="h3 m-0 text-mono">{{ '%.2f' % saldo_total }} MT</div>
            <div class="kpi-sub">Soma de todas as contas</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-sm-6 col-lg-3">
      <div class="card kpi-card kpi--entradas">
        <div class="card-body">
          <h5 class="card-title d-flex align-items-center gap-2 m-0">
            <span class="kpi-icon"><i class="bi bi-graph-up"></i></span>
            Património líquido
          </h5>
          <div class="mt-2">
            <div class="h3 m-0 text-mono">{{ '%.2f' % patrimonio_liquido }} MT</div>
            <div class="kpi-sub">Saldos - Dívidas abertas</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Linha 2: totais do mês e do histórico -->
  <div class="row g-3 mt-1">
    <div class="col-12 col-lg-6">
      <div class="card kpi-card kpi--entradas">
        <div class="card-body">
          <h5 class="card-title d-flex align-items-center gap-2 m-0">
            <span class="kpi-icon"><i class="bi bi-calendar-event"></i></span>
            Mês atual ({{ periodo_label }})
          </h5>
          <ul class="list-group mt-2">
            <li class="list-group-item"><span>Entradas</span><strong class="text-mono">{{ '%.2f' % month_in }} MT</strong></li>
            <li class="list-group-item"><span>Saídas</span><strong class="text-mono">{{ '%.2f' % month_out }} MT</strong></li>
            <li class="list-group-item"><span>Resultado</span><strong class="text-mono">{{ '%.2f' % (month_in - month_out) }} MT</strong></li>
            <li class="list-group-item small text-muted">* Totais do mês excluem transferências internas</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card kpi-card kpi--totais">
        <div class="card-body">
          <h5 class="card-title d-flex align-items-center gap-2 m-0">
            <span class="kpi-icon"><i class="bi bi-clipboard-data"></i></span>
            Totais (histórico)
          </h5>
          <ul class="list-group mt-2">
            <li class="list-group-item"><span>Total entradas</span><strong class="text-mono">{{ '%.2f' % total_in_all }} MT</strong></li>
            <li class="list-group-item"><span>Total saídas</span><strong class="text-mono">{{ '%.2f' % total_out_all }} MT</strong></li>
            <li class="list-group-item"><span>Dívidas em aberto</span><strong class="text-mono">{{ '%.2f' % dividas_abertas }} MT</strong></li>
            <li class="list-group-item small text-muted">* Totais históricos excluem transferências internas</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</section>

<section class="section report-section mt-3">
  <div class="row g-3">
    <!-- Despesas por categoria (mês) -->
    <div class="col-12 col-lg-5">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title d-flex align-items-center gap-2 m-0">
            <span class="kpi-icon"><i class="bi bi-tags"></i></span>
            Despesas por categoria (mês)
          </h5>
          <div class="table-responsive mt-2">
            <table class="table table-sm">
              <thead>
                <tr><th>Categoria</th><th class="text-end">Total (MT)</th></tr>
              </thead>
              <tbody>
                {% if cat_expenses and cat_expenses|length>0 %}
                  {% for cat, tot in cat_expenses %}
                    <tr>
                      <td>{{ cat }}</td>
                      <td class="text-end text-mono">{{ '%.2f' % tot }}</td>
                    </tr>
                  {% endfor %}
                {% else %}
                  <tr><td colspan="2" class="text-muted">Sem despesas registadas no mês.</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Saldos por Conta -->
    <div class="col-12 col-lg-7">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title d-flex align-items-center gap-2 m-0">
            <span class="kpi-icon"><i class="bi bi-bank"></i></span>
            Saldos por conta
          </h5>
          <div class="table-responsive mt-2">
            <table class="table table-sm">
              <thead>
                <tr><th>Conta</th><th>Banco</th><th>Tipo</th><th class="text-end">Saldo (MT)</th></tr>
              </thead>
              <tbody>
                {% for c in contas %}
                  <tr>
                    <td>{{ c['nome'] }}</td>
                    <td>{{ c['banco'] }}</td>
                    <td>{{ c['tipo'] }}</td>
                    <td class="text-end text-mono">{{ '%.2f' % (c['saldo'] or 0) }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div>
</section>

<section class="section report-section mt-3">
  <div class="card">
    <div class="card-body">
      <h5 class="card-title d-flex align-items-center gap-2 m-0">
        <span class="kpi-icon"><i class="bi bi-clock-history"></i></span>
        Últimos 60 movimentos — gerado em {{ hoje }}
      </h5>
      <div class="table-responsive mt-2">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Data</th><th>Conta</th><th>Tipo</th>
              <th class="text-end">Valor</th><th>Descrição</th><th>Categoria</th>
            </tr>
          </thead>
          <tbody>
            {% for r in rows %}
              {% set is_transfer = (r['categoria'] or '')|lower == 'transfer' %}
              <tr class="{{ 'table-light' if is_transfer else '' }}">
                <td>{{ r['data'] }}</td>
                <td>{{ r['conta'] }}</td>
                <td>{{ 'Entrada' if r['tipo']=='income' else 'Saída' }}</td>
                <td class="text-end text-mono">{{ '%.2f' % r['valor'] }}</td>
                <td>{{ r['descricao'] or '' }}</td>
                <td>
                  {% if is_transfer %}
                    <span class="badge-transfer"><i class="bi bi-arrow-left-right"></i> transfer</span>
                  {% else %}
                    {{ r['categoria'] or '' }}
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

    </div>
  </div>
</section>

{% endblock %}
